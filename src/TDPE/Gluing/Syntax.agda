{-# OPTIONS --without-K --safe #-}

module TDPE.Gluing.Syntax {a} (ğ’° : Set a) where

open import Level

open import TDPE.Gluing.Weakenings ğ’° using (â„­; _áµ€; _Â·_; ğŸ™; `_`; _â‡’_)
import TDPE.Gluing.Util.Equivalence as E

open import Categories.Category using (Category)

infixl 8 _âˆ·_
infixl 9 _âˆ˜_
infix 4 _â†¦â‚€_ _â†¦_

private
  variable
    Î“ Î” Î Î© : â„­
    A B : ğ’° áµ€

mutual
  data ğ”—ğ”ªâ‚€ : â„­ â†’ ğ’° áµ€ â†’ Set a where
    -- variables
    ğ“     : ğ”—ğ”ªâ‚€ (Î“ Â· A) A
    p     : ğ”—ğ”ªâ‚€ Î“ B â†’ ğ”—ğ”ªâ‚€ (Î“ Â· A) B
    -- exponentials
    Î›     : ğ”—ğ”ªâ‚€ (Î“ Â· A) B â†’ ğ”—ğ”ªâ‚€ Î“ (A â‡’ B)
    _â¦…_â¦†  : ğ”—ğ”ªâ‚€ Î“ (A â‡’ B) â†’ ğ”—ğ”ªâ‚€ Î“ A â†’ ğ”—ğ”ªâ‚€ Î“ B
    -- substitution
    _[_] : ğ”—ğ”ªâ‚€ Î“ A â†’ ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ªâ‚€ Î” A

  data ğ”—ğ”ª : â„­ â†’ â„­ â†’ Set a where
    !   : ğ”—ğ”ª Î“ ğŸ™
    _âˆ·_ : ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ªâ‚€ Î” A â†’ ğ”—ğ”ª Î” (Î“ Â· A)

Ï€ : ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ª (Î” Â· A) Î“
Ï€ !       = !
Ï€ (Î³ âˆ· a) = Ï€ Î³ âˆ· p a

-- syntactic substitution
_âˆ˜_ : ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ª Î Î” â†’ ğ”—ğ”ª Î Î“
!       âˆ˜ Î´ = !
(Î³ âˆ· a) âˆ˜ Î´ = (Î³ âˆ˜ Î´) âˆ· (a [ Î´ ])

id : âˆ€ {Î“} â†’ ğ”—ğ”ª Î“ Î“
id {ğŸ™}     = !
id {Î“ Â· A} = Ï€ id âˆ· ğ“

-- de bruijin lifiting
â†‘[_] : ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ª (Î” Â· A) (Î“ Â· A)
â†‘[ Î³ ] = Ï€ Î³ âˆ· ğ“

-- singleton
âŸ¨_âŸ© : ğ”—ğ”ªâ‚€ Î“ A â†’ ğ”—ğ”ª Î“ (ğŸ™ Â· A)
âŸ¨_âŸ© = ! âˆ·_

-- admissible definition of substitution
_âˆ˜'_ : ğ”—ğ”ª Î Î” â†’ ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ª Î Î“
_[_]' : ğ”—ğ”ªâ‚€ Î“ A â†’ ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ªâ‚€ Î” A

Î´ âˆ˜' !       = !
Î´ âˆ˜' (Î³ âˆ· a) = (Î´ âˆ˜' Î³) âˆ· (a [ Î´ ]')

ğ“         [ Î³ âˆ· a ]' = a
p t       [ Î³ âˆ· _ ]' = t [ Î³ ]'
(f â¦… x â¦†) [ Î³     ]' = (f [ Î³ ]') â¦… x [ Î³ ]' â¦†
Î› t       [ Î³     ]' = Î› (t [ â†‘[ Î³ ] ]')
(t [ Î³ ]) [ Î³'    ]' = t [ Î³' âˆ˜' Î³ ]'

mutual
  data _â†¦â‚€_ : ğ”—ğ”ªâ‚€ Î“ A â†’ ğ”—ğ”ªâ‚€ Î“ A â†’ Set a where
    Î² : âˆ€ {f : ğ”—ğ”ªâ‚€ (Î“ Â· A) B} {x : ğ”—ğ”ªâ‚€ Î“ A} â†’ Î› f â¦… x â¦† â†¦â‚€ f [ id âˆ· x ]
    Î· : âˆ€ {f : ğ”—ğ”ªâ‚€ Î“ (A â‡’ B)} â†’ f â†¦â‚€ Î› ((p f) â¦… ğ“ â¦†)
    ğ“ : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {a : ğ”—ğ”ªâ‚€ Î” A} â†’ (ğ“ [ Î³ âˆ· a ]) â†¦â‚€ a
    p : âˆ€ {t : ğ”—ğ”ªâ‚€ Î“ B} {Î³ : ğ”—ğ”ª Î” Î“} {a : ğ”—ğ”ªâ‚€ Î” A} â†’ (p t) [ Î³ âˆ· a ] â†¦â‚€ t [ Î³ ]

    app-stepâ‚— : âˆ€ {f g : ğ”—ğ”ªâ‚€ Î“ (A â‡’ B)} {x : ğ”—ğ”ªâ‚€ Î“ A} â†’ f â†¦â‚€ g â†’ f â¦… x â¦† â†¦â‚€ g â¦… x â¦†
    app-stepáµ£ : âˆ€ {f : ğ”—ğ”ªâ‚€ Î“ (A â‡’ B)} {x y : ğ”—ğ”ªâ‚€ Î“ A} â†’ x â†¦â‚€ y â†’ f â¦… x â¦† â†¦â‚€ f â¦… y â¦†
    Î›-step    : âˆ€ {f g : ğ”—ğ”ªâ‚€ (Î“ Â· A) B} â†’ f â†¦â‚€ g â†’ Î› f â†¦â‚€ Î› g
    sb-stepâ‚—  : âˆ€ {s t : ğ”—ğ”ªâ‚€ Î“ A} {Î³ : ğ”—ğ”ª Î” Î“} â†’ s â†¦â‚€ t â†’ s [ Î³ ] â†¦â‚€ t [ Î³ ]
    sb-stepáµ£  : âˆ€ {t : ğ”—ğ”ªâ‚€ Î“ A} {Î³ Î´ : ğ”—ğ”ª Î” Î“} â†’ Î³ â†¦ Î´ â†’ t [ Î³ ] â†¦â‚€ t [ Î´ ]

    sb-id    : âˆ€ {x : ğ”—ğ”ªâ‚€ Î“ A} â†’ x [ id {Î“} ] â†¦â‚€ x
    sb-app   : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {f : ğ”—ğ”ªâ‚€ Î“ (A â‡’ B)} {x : ğ”—ğ”ªâ‚€ Î“ A} â†’ (f â¦… x â¦†) [ Î³ ] â†¦â‚€ (f [ Î³ ]) â¦… x [ Î³ ] â¦†
    sb-lam   : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {f : ğ”—ğ”ªâ‚€ (Î“ Â· A) B} â†’ (Î› f) [ Î³ ] â†¦â‚€ Î› (f [ â†‘[ Î³ ] ])
    sb-assoc : âˆ€ {Î´ : ğ”—ğ”ª Î” Î“} {Î³ : ğ”—ğ”ª Î Î”} {t : ğ”—ğ”ªâ‚€ Î“ A} â†’ (t [ Î´ ]) [ Î³ ] â†¦â‚€ t [ Î´ âˆ˜ Î³ ]

  data _â†¦_ : ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ª Î” Î“ â†’ Set a where
    !-Î·     : âˆ€ {Î³ : ğ”—ğ”ª Î“ ğŸ™} â†’ Î³ â†¦ !
    âˆ·-stepâ‚— : âˆ€ {Î³ Î´ : ğ”—ğ”ª Î” Î“} {a : ğ”—ğ”ªâ‚€ Î” A} â†’ Î³ â†¦ Î´ â†’ (Î³ âˆ· a) â†¦ (Î´ âˆ· a)
    âˆ·-stepáµ£ : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {a b : ğ”—ğ”ªâ‚€ Î” A} â†’ a â†¦â‚€ b â†’ (Î³ âˆ· a) â†¦ (Î³ âˆ· b)

-- equivalence on clone
module _ {Î“ A} where
  module C = E (_â†¦â‚€_ {Î“} {A})

-- equivalence on substitutions
module _ {Î” Î“} where
  module S = E (_â†¦_ {Î”} {Î“})

âˆ·-congáµ£ : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {a b : ğ”—ğ”ªâ‚€ Î” A} â†’ a C.â‰ˆ b â†’ Î³ âˆ· a S.â‰ˆ Î³ âˆ· b
âˆ·-congáµ£ E.refl = S.refl
âˆ·-congáµ£ (E.step xs (E.fwd x)) = S.step (âˆ·-congáµ£ xs) (S.fwd (âˆ·-stepáµ£ x))
âˆ·-congáµ£ (E.step xs (E.bwd x)) = S.step (âˆ·-congáµ£ xs) (S.bwd (âˆ·-stepáµ£ x))

âˆ·-congâ‚— : âˆ€ {Î³ Î´ : ğ”—ğ”ª Î” Î“} {a : ğ”—ğ”ªâ‚€ Î” A} â†’ Î³ S.â‰ˆ Î´ â†’ Î³ âˆ· a S.â‰ˆ Î´ âˆ· a
âˆ·-congâ‚— E.refl = E.refl
âˆ·-congâ‚— (E.step xs (E.fwd x)) = E.step (âˆ·-congâ‚— xs) (E.fwd (âˆ·-stepâ‚— x))
âˆ·-congâ‚— (E.step xs (E.bwd x)) = E.step (âˆ·-congâ‚— xs) (E.bwd (âˆ·-stepâ‚— x))

âˆ·-congâ‚‚ : âˆ€ {Î³ Î´ : ğ”—ğ”ª Î” Î“} {a b : ğ”—ğ”ªâ‚€ Î” A} â†’ Î³ S.â‰ˆ Î´ â†’ a C.â‰ˆ b â†’ Î³ âˆ· a S.â‰ˆ Î´ âˆ· b
âˆ·-congâ‚‚ x y = S.trans (âˆ·-congâ‚— x) (âˆ·-congáµ£ y)

Ï€-ext : âˆ€ {Î“} {Î´ : ğ”—ğ”ª Î Î”} {Î³ : ğ”—ğ”ª Î” Î“} {a : ğ”—ğ”ªâ‚€ Î A} â†’ Ï€ Î³ âˆ˜ (Î´ âˆ· a) S.â‰ˆ Î³ âˆ˜ Î´
Ï€-ext {Î“ = ğŸ™}     {Î³ = !}     = S.refl
Ï€-ext {Î“ = Î“ Â· B} {Î³ = Î³ âˆ· b} = âˆ·-congâ‚‚ Ï€-ext (C.unit p)

âˆ˜-identityË¡ : âˆ€ {Î“} {Î³ : ğ”—ğ”ª Î” Î“} â†’ id âˆ˜ Î³ S.â‰ˆ Î³
âˆ˜-identityË¡ {Î“ = ğŸ™}     {Î³ = !} = S.refl
âˆ˜-identityË¡ {Î“ = Î“ Â· A} {Î³ âˆ· a} = âˆ·-congâ‚‚ (S.trans Ï€-ext âˆ˜-identityË¡) (C.unit ğ“)

âˆ˜-identityÊ³ : âˆ€ {Î“} {Î³ : ğ”—ğ”ª Î” Î“} â†’ Î³ âˆ˜ id S.â‰ˆ Î³
âˆ˜-identityÊ³ {Î“ = ğŸ™}     {Î³ = !}     = S.refl
âˆ˜-identityÊ³ {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} = âˆ·-congâ‚‚ âˆ˜-identityÊ³ (C.unit sb-id)

âˆ˜-identityÂ² : âˆ€ {Î“} â†’ id âˆ˜ id S.â‰ˆ id {Î“}
âˆ˜-identityÂ² {Î“ = ğŸ™}     = S.refl
âˆ˜-identityÂ² {Î“ = Î“ Â· A} = âˆ·-congâ‚‚ (S.trans Ï€-ext âˆ˜-identityË¡) (C.unit ğ“)

âˆ˜-assoc : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {Î´ : ğ”—ğ”ª Î Î”} {Î¶ : ğ”—ğ”ª Î© Î}
          â†’ (Î³ âˆ˜ Î´) âˆ˜ Î¶ S.â‰ˆ Î³ âˆ˜ (Î´ âˆ˜ Î¶)
âˆ˜-assoc {Î³ = !}     {Î´} {Î¶} = S.refl
âˆ˜-assoc {Î³ = Î³ âˆ· x} {Î´} {Î¶} = âˆ·-congâ‚‚ âˆ˜-assoc (C.unit sb-assoc)

âˆ˜-sym-assoc : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {Î´ : ğ”—ğ”ª Î Î”} {Î¶ : ğ”—ğ”ª Î© Î}
              â†’ Î³ âˆ˜ (Î´ âˆ˜ Î¶) S.â‰ˆ (Î³ âˆ˜ Î´) âˆ˜ Î¶
âˆ˜-sym-assoc = S.sym âˆ˜-assoc

âˆ˜-stepâ‚— : âˆ€ {Î³ Î³' : ğ”—ğ”ª Î” Î“} {Î´ : ğ”—ğ”ª Î Î”} â†’ Î³ S.~ Î³' â†’ Î³ âˆ˜ Î´ S.~ Î³' âˆ˜ Î´
âˆ˜-stepâ‚— {Î“ = ğŸ™} {Î³ = !} _ = S.bwd !-Î·
âˆ˜-stepâ‚— {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} (S.fwd (âˆ·-stepâ‚— x))
  with âˆ˜-stepâ‚— (S.fwd x)
... | S.fwd x' = S.fwd (âˆ·-stepâ‚— x')
... | S.bwd x' = S.bwd (âˆ·-stepâ‚— x')
âˆ˜-stepâ‚— {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} (S.bwd (âˆ·-stepâ‚— x))
  with âˆ˜-stepâ‚— (S.bwd x)
... | S.fwd x' = S.fwd (âˆ·-stepâ‚— x')
... | S.bwd x' = S.bwd (âˆ·-stepâ‚— x')
âˆ˜-stepâ‚— {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} (S.fwd (âˆ·-stepáµ£ x)) = S.fwd (âˆ·-stepáµ£ (sb-stepâ‚— x))
âˆ˜-stepâ‚— {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} (S.bwd (âˆ·-stepáµ£ x)) = S.bwd (âˆ·-stepáµ£ (sb-stepâ‚— x))

âˆ˜-stepáµ£ : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {Î´ Î´' : ğ”—ğ”ª Î Î”} â†’ Î´ S.~ Î´' â†’ Î³ âˆ˜ Î´ S.â‰ˆ Î³ âˆ˜ Î´'
âˆ˜-stepáµ£ {Î“ = ğŸ™} {Î³ = !} x = S.refl
âˆ˜-stepáµ£ {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} (S.fwd (âˆ·-stepâ‚— x)) =
  âˆ·-congâ‚‚ (âˆ˜-stepáµ£ (S.fwd (âˆ·-stepâ‚— x))) (C.unit (sb-stepáµ£ (âˆ·-stepâ‚— x)))
âˆ˜-stepáµ£ {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} (S.fwd (âˆ·-stepáµ£ x)) =
  âˆ·-congâ‚‚ (âˆ˜-stepáµ£ (S.fwd (âˆ·-stepáµ£ x))) (C.unit (sb-stepáµ£ (âˆ·-stepáµ£ x)))
âˆ˜-stepáµ£ {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} (S.bwd (âˆ·-stepâ‚— x)) =
  S.sym (âˆ·-congâ‚‚ (âˆ˜-stepáµ£ (S.fwd (âˆ·-stepâ‚— x))) (C.unit (sb-stepáµ£ (âˆ·-stepâ‚— x))))
âˆ˜-stepáµ£ {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} (S.bwd (âˆ·-stepáµ£ x)) =
  S.sym (âˆ·-congâ‚‚ (âˆ˜-stepáµ£ (S.fwd (âˆ·-stepáµ£ x))) (C.unit (sb-stepáµ£ (âˆ·-stepáµ£ x))))
âˆ˜-stepáµ£ {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} (S.fwd (!-Î·)) =
  âˆ·-congâ‚‚ (âˆ˜-stepáµ£ (S.fwd !-Î·)) (C.unit (sb-stepáµ£ !-Î·))
âˆ˜-stepáµ£ {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} (S.bwd (!-Î·)) =
  S.sym (âˆ·-congâ‚‚ (âˆ˜-stepáµ£ (S.fwd (!-Î·))) (C.unit (sb-stepáµ£ !-Î·)))

âˆ˜-congâ‚— : âˆ€ {Î³ Î³' : ğ”—ğ”ª Î” Î“} {Î´ : ğ”—ğ”ª Î Î”}
          â†’ Î³ S.â‰ˆ Î³' â†’ Î³ âˆ˜ Î´ S.â‰ˆ Î³' âˆ˜ Î´
âˆ˜-congâ‚— E.refl        = S.refl
âˆ˜-congâ‚— (E.step xs x) = S.step (âˆ˜-congâ‚— xs) (âˆ˜-stepâ‚— x)

âˆ˜-congáµ£ : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {Î´ Î´' : ğ”—ğ”ª Î Î”}
          â†’ Î´ S.â‰ˆ Î´' â†’ Î³ âˆ˜ Î´ S.â‰ˆ Î³ âˆ˜ Î´'
âˆ˜-congáµ£ E.refl        = S.refl
âˆ˜-congáµ£ (E.step xs x) = S.trans (âˆ˜-congáµ£ xs) (âˆ˜-stepáµ£ x)

âˆ˜-resp-â‰ˆ : âˆ€ {Î Î” Î“} {Î³ Î³' : ğ”—ğ”ª Î” Î“} {Î´ Î´' : ğ”—ğ”ª Î Î”}
           â†’ Î³ S.â‰ˆ Î³' â†’ Î´ S.â‰ˆ Î´' â†’ Î³ âˆ˜ Î´ S.â‰ˆ Î³' âˆ˜ Î´'
âˆ˜-resp-â‰ˆ x y = S.trans (âˆ˜-congâ‚— x) (âˆ˜-congáµ£ y)

ğ•‹ğ• : Category a a a
ğ•‹ğ• = record
  { Obj = â„­
  ; _â‡’_ = ğ”—ğ”ª
  ; _â‰ˆ_ = S._â‰ˆ_
  ; id = id
  ; _âˆ˜_ = _âˆ˜_
  ; assoc = âˆ˜-assoc
  ; sym-assoc = âˆ˜-sym-assoc
  ; identityË¡ = âˆ˜-identityË¡
  ; identityÊ³ = âˆ˜-identityÊ³
  ; identityÂ² = âˆ˜-identityÂ²
  ; equiv = S.is-equiv
  ; âˆ˜-resp-â‰ˆ = âˆ˜-resp-â‰ˆ
  }
