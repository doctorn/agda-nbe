{-# OPTIONS --without-K --safe #-}

module TDPE.Gluing.Syntax {a} (ğ’° : Set a) where

open import Level

open import TDPE.Gluing.Weakenings ğ’° using (â„­; _áµ€; _Â·_; ğŸ™; `_`; _â‡’_)
import TDPE.Gluing.Util.Equivalence as E

open import Categories.Category using (Category)

infixl 8 _âˆ·_
infixl 9 _âˆ˜_
infix 4 _â†¦â‚€_ _â†¦_

private
  variable
    Î“ Î” Î Î© : â„­
    A B : ğ’° áµ€

mutual
  data ğ”—ğ”ªâ‚€ : â„­ â†’ ğ’° áµ€ â†’ Set a where
    -- variables
    ğ“     : ğ”—ğ”ªâ‚€ (Î“ Â· A) A
    p     : ğ”—ğ”ªâ‚€ Î“ B â†’ ğ”—ğ”ªâ‚€ (Î“ Â· A) B
    -- exponentials
    Î›     : ğ”—ğ”ªâ‚€ (Î“ Â· A) B â†’ ğ”—ğ”ªâ‚€ Î“ (A â‡’ B)
    _â¦…_â¦†  : ğ”—ğ”ªâ‚€ Î“ (A â‡’ B) â†’ ğ”—ğ”ªâ‚€ Î“ A â†’ ğ”—ğ”ªâ‚€ Î“ B
    -- substitution
    _[_] : ğ”—ğ”ªâ‚€ Î“ A â†’ ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ªâ‚€ Î” A

  data ğ”—ğ”ª : â„­ â†’ â„­ â†’ Set a where
    !   : ğ”—ğ”ª Î“ ğŸ™
    _âˆ·_ : ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ªâ‚€ Î” A â†’ ğ”—ğ”ª Î” (Î“ Â· A)

Ï€ : ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ª (Î” Â· A) Î“
Ï€ !       = !
Ï€ (Î³ âˆ· a) = Ï€ Î³ âˆ· p a

-- syntactic substitution
_âˆ˜_ : ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ª Î Î” â†’ ğ”—ğ”ª Î Î“
!       âˆ˜ Î´ = !
(Î³ âˆ· a) âˆ˜ Î´ = (Î³ âˆ˜ Î´) âˆ· (a [ Î´ ])

id : âˆ€ {Î“} â†’ ğ”—ğ”ª Î“ Î“
id {ğŸ™}     = !
id {Î“ Â· A} = Ï€ id âˆ· ğ“

-- de bruijin lifiting
â†‘[_] : ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ª (Î” Â· A) (Î“ Â· A)
â†‘[ Î³ ] = Ï€ Î³ âˆ· ğ“

-- singleton
âŸ¨_âŸ© : ğ”—ğ”ªâ‚€ Î“ A â†’ ğ”—ğ”ª Î“ (ğŸ™ Â· A)
âŸ¨_âŸ© = ! âˆ·_

-- admissible definition of substitution
_âˆ˜'_ : ğ”—ğ”ª Î Î” â†’ ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ª Î Î“
_[_]' : ğ”—ğ”ªâ‚€ Î“ A â†’ ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ªâ‚€ Î” A

Î´ âˆ˜' !       = !
Î´ âˆ˜' (Î³ âˆ· a) = (Î´ âˆ˜' Î³) âˆ· (a [ Î´ ]')

ğ“         [ Î³ âˆ· a ]' = a
p t       [ Î³ âˆ· _ ]' = t [ Î³ ]'
(f â¦… x â¦†) [ Î³     ]' = (f [ Î³ ]') â¦… x [ Î³ ]' â¦†
Î› t       [ Î³     ]' = Î› (t [ â†‘[ Î³ ] ]')
(t [ Î³ ]) [ Î³'    ]' = t [ Î³' âˆ˜' Î³ ]'

mutual
  data _â†¦â‚€_ : ğ”—ğ”ªâ‚€ Î“ A â†’ ğ”—ğ”ªâ‚€ Î“ A â†’ Set a where
    Î›Î²â‚€ : âˆ€ {f : ğ”—ğ”ªâ‚€ (Î“ Â· A) B} {x : ğ”—ğ”ªâ‚€ Î“ A} â†’ Î› f â¦… x â¦† â†¦â‚€ f [ id âˆ· x ]
    Î›Î·â‚€ : âˆ€ {f : ğ”—ğ”ªâ‚€ Î“ (A â‡’ B)} â†’ f â†¦â‚€ Î› ((p f) â¦… ğ“ â¦†)
    vğ“â‚€ : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {a : ğ”—ğ”ªâ‚€ Î” A} â†’ (ğ“ [ Î³ âˆ· a ]) â†¦â‚€ a
    vpâ‚€ : âˆ€ {t : ğ”—ğ”ªâ‚€ Î“ B} {Î³ : ğ”—ğ”ª Î” Î“} {a : ğ”—ğ”ªâ‚€ Î” A} â†’ (p t) [ Î³ âˆ· a ] â†¦â‚€ t [ Î³ ]

    app-stepâ‚— : âˆ€ {f g : ğ”—ğ”ªâ‚€ Î“ (A â‡’ B)} {x : ğ”—ğ”ªâ‚€ Î“ A} â†’ f â†¦â‚€ g â†’ f â¦… x â¦† â†¦â‚€ g â¦… x â¦†
    app-stepáµ£ : âˆ€ {f : ğ”—ğ”ªâ‚€ Î“ (A â‡’ B)} {x y : ğ”—ğ”ªâ‚€ Î“ A} â†’ x â†¦â‚€ y â†’ f â¦… x â¦† â†¦â‚€ f â¦… y â¦†
    Î›-step    : âˆ€ {f g : ğ”—ğ”ªâ‚€ (Î“ Â· A) B} â†’ f â†¦â‚€ g â†’ Î› f â†¦â‚€ Î› g
    sb-stepâ‚—  : âˆ€ {s t : ğ”—ğ”ªâ‚€ Î“ A} {Î³ : ğ”—ğ”ª Î” Î“} â†’ s â†¦â‚€ t â†’ s [ Î³ ] â†¦â‚€ t [ Î³ ]
    sb-stepáµ£  : âˆ€ {t : ğ”—ğ”ªâ‚€ Î“ A} {Î³ Î´ : ğ”—ğ”ª Î” Î“} â†’ Î³ â†¦ Î´ â†’ t [ Î³ ] â†¦â‚€ t [ Î´ ]

    sb-idâ‚€    : âˆ€ {x : ğ”—ğ”ªâ‚€ Î“ A} â†’ x [ id {Î“} ] â†¦â‚€ x
    sb-appâ‚€   : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {f : ğ”—ğ”ªâ‚€ Î“ (A â‡’ B)} {x : ğ”—ğ”ªâ‚€ Î“ A} â†’ (f â¦… x â¦†) [ Î³ ] â†¦â‚€ (f [ Î³ ]) â¦… x [ Î³ ] â¦†
    sb-lamâ‚€   : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {f : ğ”—ğ”ªâ‚€ (Î“ Â· A) B} â†’ (Î› f) [ Î³ ] â†¦â‚€ Î› (f [ â†‘[ Î³ ] ])
    sb-assocâ‚€ : âˆ€ {Î´ : ğ”—ğ”ª Î” Î“} {Î³ : ğ”—ğ”ª Î Î”} {t : ğ”—ğ”ªâ‚€ Î“ A} â†’ (t [ Î´ ]) [ Î³ ] â†¦â‚€ t [ Î´ âˆ˜ Î³ ]

  data _â†¦_ : ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ª Î” Î“ â†’ Set a where
    !Î·â‚€     : âˆ€ {Î³ : ğ”—ğ”ª Î“ ğŸ™} â†’ Î³ â†¦ !
    âˆ·-stepâ‚— : âˆ€ {Î³ Î´ : ğ”—ğ”ª Î” Î“} {a : ğ”—ğ”ªâ‚€ Î” A} â†’ Î³ â†¦ Î´ â†’ (Î³ âˆ· a) â†¦ (Î´ âˆ· a)
    âˆ·-stepáµ£ : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {a b : ğ”—ğ”ªâ‚€ Î” A} â†’ a â†¦â‚€ b â†’ (Î³ âˆ· a) â†¦ (Î³ âˆ· b)

-- equivalence on clone
module _ {Î“ A} where
  module C = E (_â†¦â‚€_ {Î“} {A})

-- equivalence on substitutions
module _ {Î” Î“} where
  module S = E (_â†¦_ {Î”} {Î“})

project : {Î³ Î´ : ğ”—ğ”ª Î” Î“} {a b : ğ”—ğ”ªâ‚€ Î” A} â†’ Î³ âˆ· a S.â‰ˆ Î´ âˆ· b â†’ a C.â‰ˆ b
project = S.induct C.is-equiv P I
  where P : ğ”—ğ”ª Î” (Î“ Â· A) â†’ ğ”—ğ”ªâ‚€ Î” A
        P (_ âˆ· a) = a

        I : {Î³ Î´ : ğ”—ğ”ª Î” (Î“ Â· A)} â†’ Î³ â†¦ Î´ â†’ P Î³ C.â‰ˆ P Î´
        I (âˆ·-stepâ‚— x) = C.refl
        I (âˆ·-stepáµ£ x) = C.unit x

Î›Î² : âˆ€ {f : ğ”—ğ”ªâ‚€ (Î“ Â· A) B} {x : ğ”—ğ”ªâ‚€ Î“ A} â†’ Î› f â¦… x â¦† C.â‰ˆ f [ id âˆ· x ]
Î›Î² = C.unit Î›Î²â‚€

Î›Î· : âˆ€ {f : ğ”—ğ”ªâ‚€ Î“ (A â‡’ B)} â†’ f C.â‰ˆ Î› ((p f) â¦… ğ“ â¦†)
Î›Î· = C.unit Î›Î·â‚€

vğ“ : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {a : ğ”—ğ”ªâ‚€ Î” A} â†’ (ğ“ [ Î³ âˆ· a ]) C.â‰ˆ a
vğ“ = C.unit vğ“â‚€

vp : âˆ€ {t : ğ”—ğ”ªâ‚€ Î“ B} {Î³ : ğ”—ğ”ª Î” Î“} {a : ğ”—ğ”ªâ‚€ Î” A} â†’ (p t) [ Î³ âˆ· a ] C.â‰ˆ t [ Î³ ]
vp = C.unit vpâ‚€

sb-id : âˆ€ {x : ğ”—ğ”ªâ‚€ Î“ A} â†’ x [ id {Î“} ] C.â‰ˆ x
sb-id = C.unit sb-idâ‚€

sb-app : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {f : ğ”—ğ”ªâ‚€ Î“ (A â‡’ B)} {x : ğ”—ğ”ªâ‚€ Î“ A} â†’ (f â¦… x â¦†) [ Î³ ] C.â‰ˆ (f [ Î³ ]) â¦… x [ Î³ ] â¦†
sb-app = C.unit sb-appâ‚€

sb-lam : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {f : ğ”—ğ”ªâ‚€ (Î“ Â· A) B} â†’ (Î› f) [ Î³ ] C.â‰ˆ Î› (f [ â†‘[ Î³ ] ])
sb-lam = C.unit sb-lamâ‚€

sb-assoc : âˆ€ {Î´ : ğ”—ğ”ª Î” Î“} {Î³ : ğ”—ğ”ª Î Î”} {t : ğ”—ğ”ªâ‚€ Î“ A} â†’ (t [ Î´ ]) [ Î³ ] C.â‰ˆ t [ Î´ âˆ˜ Î³ ]
sb-assoc = C.unit sb-assocâ‚€

!Î· : âˆ€ {Î³ : ğ”—ğ”ª Î“ ğŸ™} â†’ Î³ S.â‰ˆ !
!Î· = S.unit !Î·â‚€

âˆ·-congáµ£ : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {a b : ğ”—ğ”ªâ‚€ Î” A} â†’ a C.â‰ˆ b â†’ Î³ âˆ· a S.â‰ˆ Î³ âˆ· b
âˆ·-congáµ£ = C.induct S.is-equiv (_ âˆ·_) (Î» x â†’ S.unit (âˆ·-stepáµ£ x))

âˆ·-congâ‚— : âˆ€ {Î³ Î´ : ğ”—ğ”ª Î” Î“} {a : ğ”—ğ”ªâ‚€ Î” A} â†’ Î³ S.â‰ˆ Î´ â†’ Î³ âˆ· a S.â‰ˆ Î´ âˆ· a
âˆ·-congâ‚— = S.induct S.is-equiv (_âˆ· _) Î» x â†’ S.unit (âˆ·-stepâ‚— x)

âˆ·-congâ‚‚ : âˆ€ {Î³ Î´ : ğ”—ğ”ª Î” Î“} {a b : ğ”—ğ”ªâ‚€ Î” A} â†’ Î³ S.â‰ˆ Î´ â†’ a C.â‰ˆ b â†’ Î³ âˆ· a S.â‰ˆ Î´ âˆ· b
âˆ·-congâ‚‚ x y = S.trans (âˆ·-congâ‚— x) (âˆ·-congáµ£ y)

Ï€Î² : âˆ€ {Î“} {Î´ : ğ”—ğ”ª Î Î”} {Î³ : ğ”—ğ”ª Î” Î“} {a : ğ”—ğ”ªâ‚€ Î A} â†’ Ï€ Î³ âˆ˜ (Î´ âˆ· a) S.â‰ˆ Î³ âˆ˜ Î´
Ï€Î² {Î“ = ğŸ™}     {Î³ = !}     = S.refl
Ï€Î² {Î“ = Î“ Â· B} {Î³ = Î³ âˆ· b} = âˆ·-congâ‚‚ Ï€Î² vp

âˆ˜-identityË¡ : âˆ€ {Î“} {Î³ : ğ”—ğ”ª Î” Î“} â†’ id âˆ˜ Î³ S.â‰ˆ Î³
âˆ˜-identityË¡ {Î“ = ğŸ™}     {Î³ = !} = S.refl
âˆ˜-identityË¡ {Î“ = Î“ Â· A} {Î³ âˆ· a} = âˆ·-congâ‚‚ (S.trans Ï€Î² âˆ˜-identityË¡) vğ“

âˆ˜-identityÊ³ : âˆ€ {Î“} {Î³ : ğ”—ğ”ª Î” Î“} â†’ Î³ âˆ˜ id S.â‰ˆ Î³
âˆ˜-identityÊ³ {Î“ = ğŸ™}     {Î³ = !}     = S.refl
âˆ˜-identityÊ³ {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} = âˆ·-congâ‚‚ âˆ˜-identityÊ³ sb-id

âˆ˜-identityÂ² : âˆ€ {Î“} â†’ id âˆ˜ id S.â‰ˆ id {Î“}
âˆ˜-identityÂ² {Î“ = ğŸ™}     = S.refl
âˆ˜-identityÂ² {Î“ = Î“ Â· A} = âˆ·-congâ‚‚ (S.trans Ï€Î² âˆ˜-identityË¡) vğ“

âˆ˜-assoc : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {Î´ : ğ”—ğ”ª Î Î”} {Î¶ : ğ”—ğ”ª Î© Î}
          â†’ (Î³ âˆ˜ Î´) âˆ˜ Î¶ S.â‰ˆ Î³ âˆ˜ (Î´ âˆ˜ Î¶)
âˆ˜-assoc {Î³ = !}     {Î´} {Î¶} = S.refl
âˆ˜-assoc {Î³ = Î³ âˆ· x} {Î´} {Î¶} = âˆ·-congâ‚‚ âˆ˜-assoc sb-assoc

âˆ˜-sym-assoc : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {Î´ : ğ”—ğ”ª Î Î”} {Î¶ : ğ”—ğ”ª Î© Î}
              â†’ Î³ âˆ˜ (Î´ âˆ˜ Î¶) S.â‰ˆ (Î³ âˆ˜ Î´) âˆ˜ Î¶
âˆ˜-sym-assoc = S.sym âˆ˜-assoc

âˆ˜-stepâ‚— : âˆ€ {Î³ Î³' : ğ”—ğ”ª Î” Î“} {Î´ : ğ”—ğ”ª Î Î”} â†’ Î³ â†¦ Î³' â†’ Î³ âˆ˜ Î´ S.â‰ˆ Î³' âˆ˜ Î´
âˆ˜-stepâ‚— !Î·â‚€         = !Î·
âˆ˜-stepâ‚— (âˆ·-stepâ‚— x) = âˆ·-congâ‚— (âˆ˜-stepâ‚— x)
âˆ˜-stepâ‚— (âˆ·-stepáµ£ x) = âˆ·-congáµ£ (C.unit (sb-stepâ‚— x))

âˆ˜-stepáµ£ : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {Î´ Î´' : ğ”—ğ”ª Î Î”} â†’ Î´ â†¦ Î´' â†’ Î³ âˆ˜ Î´ S.â‰ˆ Î³ âˆ˜ Î´'
âˆ˜-stepáµ£ {Î³ = !}             _   = S.refl
âˆ˜-stepáµ£ {Î³ = Î³ âˆ· a} {Î´ = !} !Î·â‚€ = S.refl
âˆ˜-stepáµ£ {Î³ = Î³ âˆ· a}         q   = âˆ·-congâ‚‚ (âˆ˜-stepáµ£ q) (C.unit (sb-stepáµ£ q))

âˆ˜-congâ‚— : âˆ€ {Î³ Î³' : ğ”—ğ”ª Î” Î“} {Î´ : ğ”—ğ”ª Î Î”}
          â†’ Î³ S.â‰ˆ Î³' â†’ Î³ âˆ˜ Î´ S.â‰ˆ Î³' âˆ˜ Î´
âˆ˜-congâ‚— = S.induct S.is-equiv (_âˆ˜ _) âˆ˜-stepâ‚—

âˆ˜-congáµ£ : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {Î´ Î´' : ğ”—ğ”ª Î Î”}
          â†’ Î´ S.â‰ˆ Î´' â†’ Î³ âˆ˜ Î´ S.â‰ˆ Î³ âˆ˜ Î´'
âˆ˜-congáµ£ = S.induct S.is-equiv (_ âˆ˜_) âˆ˜-stepáµ£

âˆ˜-resp-â‰ˆ : âˆ€ {Î Î” Î“} {Î³ Î³' : ğ”—ğ”ª Î” Î“} {Î´ Î´' : ğ”—ğ”ª Î Î”}
           â†’ Î³ S.â‰ˆ Î³' â†’ Î´ S.â‰ˆ Î´' â†’ Î³ âˆ˜ Î´ S.â‰ˆ Î³' âˆ˜ Î´'
âˆ˜-resp-â‰ˆ x y = S.trans (âˆ˜-congâ‚— x) (âˆ˜-congáµ£ y)

ğ•‹ğ• : Category a a a
ğ•‹ğ• = record
  { Obj = â„­
  ; _â‡’_ = ğ”—ğ”ª
  ; _â‰ˆ_ = S._â‰ˆ_
  ; id = id
  ; _âˆ˜_ = _âˆ˜_
  ; assoc = âˆ˜-assoc
  ; sym-assoc = âˆ˜-sym-assoc
  ; identityË¡ = âˆ˜-identityË¡
  ; identityÊ³ = âˆ˜-identityÊ³
  ; identityÂ² = âˆ˜-identityÂ²
  ; equiv = S.is-equiv
  ; âˆ˜-resp-â‰ˆ = âˆ˜-resp-â‰ˆ
  }

open import TDPE.Gluing.Categories.Category.ContextualCartesian ğ•‹ğ•

ğ•‹ğ•-CC : ContextualCartesian (ğ’° áµ€)
ğ•‹ğ•-CC = record
  { terminal = record
    { âŠ¤ = ğŸ™
    ; âŠ¤-is-terminal = record
      { ! = !
      ; !-unique = Î» f â†’ S.sym !Î·
      }
    }
  ; _Â·_ = _Â·_
  ; Ï€ = Ï€ id
  ; ğ“ = ! âˆ· ğ“
  ; extensions = record
    { âŸ¨_,_âŸ© = Î» Î³ a â†’ Î³ âˆ· (ğ“ [ a ])
    ; projectâ‚ = S.trans Ï€Î² âˆ˜-identityË¡
    ; projectâ‚‚ = projectâ‚‚
    ; unique = unique
    }
  }
  where projectâ‚‚ : âˆ€ {Î³ : ğ”—ğ”ª Î” Î“} {Î´ : ğ”—ğ”ª Î” (ğŸ™ Â· A)} â†’ (! âˆ· ğ“) âˆ˜ (Î³ âˆ· (ğ“ [ Î´ ])) S.â‰ˆ Î´
        projectâ‚‚ {Î´ = ! âˆ· a} = âˆ·-congáµ£ (C.trans vğ“ vğ“)

        unique : âˆ€ {Î´ : ğ”—ğ”ª Î” (Î“ Â· A)} {Î³ : ğ”—ğ”ª Î” Î“} {a : ğ”—ğ”ª Î” (ğŸ™ Â· A)}
                 â†’ Ï€ id âˆ˜ Î´ S.â‰ˆ Î³ â†’ ! âˆ· (ğ“ [ Î´ ]) S.â‰ˆ a â†’ Î³ âˆ· (ğ“ [ a ]) S.â‰ˆ Î´
        unique {Î´ = Î´ âˆ· b} {a = ! âˆ· a} pâ‚ pâ‚‚ =
          âˆ·-congâ‚‚ (S.trans (S.sym pâ‚) (S.trans Ï€Î² âˆ˜-identityË¡))
                  (C.trans vğ“ (C.trans (C.sym (project pâ‚‚)) vğ“))
