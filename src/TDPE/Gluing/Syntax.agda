{-# OPTIONS --without-K --safe #-}

module TDPE.Gluing.Syntax {a} (ğ’° : Set a) where

open import Level

open import TDPE.Gluing.Weakenings ğ’° using (â„­; _áµ€; _Â·_; ğŸ™; `_`; _â‡’_)

open import Categories.Category using (Category)

infixl 8 _âˆ·_
infixl 9 _âˆ˜_
infix 4 _â†¦â‚€_ _â†¦_ _~_ _â‰ˆ_

mutual
  data ğ”—ğ”ªâ‚€ : â„­ â†’ ğ’° áµ€ â†’ Set a where
    -- variables
    ğ“     : âˆ€ {Î“ A} â†’ ğ”—ğ”ªâ‚€ (Î“ Â· A) A
    p     : âˆ€ {Î“ A B} â†’ ğ”—ğ”ªâ‚€ Î“ B â†’ ğ”—ğ”ªâ‚€ (Î“ Â· A) B
    -- exponentials
    Î›     : âˆ€ {Î“ A B} â†’ ğ”—ğ”ªâ‚€ (Î“ Â· A) B â†’ ğ”—ğ”ªâ‚€ Î“ (A â‡’ B)
    _â¦…_â¦†  : âˆ€ {Î“ A B} â†’ ğ”—ğ”ªâ‚€ Î“ (A â‡’ B) â†’ ğ”—ğ”ªâ‚€ Î“ A â†’ ğ”—ğ”ªâ‚€ Î“ B
    -- substitution
    _[_] : âˆ€ {Î” Î“ A} â†’ ğ”—ğ”ªâ‚€ Î“ A â†’ ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ªâ‚€ Î” A

  data ğ”—ğ”ª : â„­ â†’ â„­ â†’ Set a where
    !   : âˆ€ {Î“} â†’ ğ”—ğ”ª Î“ ğŸ™
    _âˆ·_ : âˆ€ {Î” Î“ A} â†’ ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ªâ‚€ Î” A â†’ ğ”—ğ”ª Î” (Î“ Â· A)

Ï€ : âˆ€ {Î“ A Î”} â†’ ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ª (Î” Â· A) Î“
Ï€ !       = !
Ï€ (Î³ âˆ· a) = Ï€ Î³ âˆ· p a

-- syntactic substitution
_âˆ˜_ : âˆ€ {Î“ Î” Î} â†’ ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ª Î Î” â†’ ğ”—ğ”ª Î Î“
!       âˆ˜ Î´ = !
(Î³ âˆ· a) âˆ˜ Î´ = (Î³ âˆ˜ Î´) âˆ· (a [ Î´ ])

id : âˆ€ {Î“} â†’ ğ”—ğ”ª Î“ Î“
id {ğŸ™}     = !
id {Î“ Â· A} = Ï€ id âˆ· ğ“

-- de bruijin lifiting
â†‘[_] : âˆ€ {Î” Î“ A} â†’ ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ª (Î” Â· A) (Î“ Â· A)
â†‘[ Î³ ] = Ï€ Î³ âˆ· ğ“

-- singleton
âŸ¨_âŸ© : âˆ€ {Î“ A} â†’ ğ”—ğ”ªâ‚€ Î“ A â†’ ğ”—ğ”ª Î“ (ğŸ™ Â· A)
âŸ¨_âŸ© = ! âˆ·_

-- admissible definition of substitution
_âˆ˜'_ : âˆ€ {Î“ Î” Î} â†’ ğ”—ğ”ª Î Î” â†’ ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ª Î Î“
_[_]' : âˆ€ {Î” Î“ A} â†’ ğ”—ğ”ªâ‚€ Î“ A â†’ ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ªâ‚€ Î” A

Î´ âˆ˜' !       = !
Î´ âˆ˜' (Î³ âˆ· a) = (Î´ âˆ˜' Î³) âˆ· (a [ Î´ ]')

ğ“         [ Î³ âˆ· a ]' = a
p t       [ Î³ âˆ· _ ]' = t [ Î³ ]'
(f â¦… x â¦†) [ Î³     ]' = (f [ Î³ ]') â¦… x [ Î³ ]' â¦†
Î› t       [ Î³     ]' = Î› (t [ â†‘[ Î³ ] ]')
(t [ Î³ ]) [ Î³' ]' = t [ Î³' âˆ˜' Î³ ]'

mutual
  data _â†¦â‚€_ : âˆ€ {Î“ A} â†’ ğ”—ğ”ªâ‚€ Î“ A â†’ ğ”—ğ”ªâ‚€ Î“ A â†’ Set a where
    Î²     : âˆ€ {Î“ A B} (f : ğ”—ğ”ªâ‚€ (Î“ Â· A) B) (x : ğ”—ğ”ªâ‚€ Î“ A)  x â†’ Î› f â¦… x â¦† â†¦â‚€ f [ id âˆ· x ]
    Î·     : âˆ€ {Î“ A B} (f : ğ”—ğ”ªâ‚€ Î“ (A â‡’ B)) â†’ f â†¦â‚€ Î› ((p f) â¦… ğ“ â¦†)
    ğ“     : âˆ€ {Î” Î“ A} (Î³ : ğ”—ğ”ª Î” Î“) (a : ğ”—ğ”ªâ‚€ Î” A) â†’ (ğ“ [ Î³ âˆ· a ]) â†¦â‚€ a
    p     : âˆ€ {Î” Î“ A B} (t : ğ”—ğ”ªâ‚€ Î“ B) (Î³ : ğ”—ğ”ª Î” Î“) (a : ğ”—ğ”ªâ‚€ Î” A) â†’ (p t) [ Î³ âˆ· a ] â†¦â‚€ t [ Î³ ]

    _â¦…_â¦†â‚— : âˆ€ {Î“ A B} {f g : ğ”—ğ”ªâ‚€ Î“ (A â‡’ B)} â†’ f â†¦â‚€ g â†’ (x : ğ”—ğ”ªâ‚€ Î“ A) â†’ f â¦… x â¦† â†¦â‚€ g â¦… x â¦†
    _â¦…_â¦†áµ£ : âˆ€ {Î“ A B} (f : ğ”—ğ”ªâ‚€ Î“ (A â‡’ B)) {x y : ğ”—ğ”ªâ‚€ Î“ A} â†’ x â†¦â‚€ y â†’ f â¦… x â¦† â†¦â‚€ f â¦… y â¦†
    Î›     : âˆ€ {Î“ A B} {f g : ğ”—ğ”ªâ‚€ (Î“ Â· A) B} â†’ f â†¦â‚€ g â†’ Î› f â†¦â‚€ Î› g
    _[_]â‚— : âˆ€ {Î” Î“ A} {s t : ğ”—ğ”ªâ‚€ Î“ A} â†’ s â†¦â‚€ t â†’ (Î³ : ğ”—ğ”ª Î” Î“) â†’ s [ Î³ ] â†¦â‚€ t [ Î³ ]
    _[_]áµ£ : âˆ€ {Î” Î“ A} (t : ğ”—ğ”ªâ‚€ Î“ A) {Î³ Î´ : ğ”—ğ”ª Î” Î“} â†’ Î³ â†¦ Î´ â†’ t [ Î³ ] â†¦â‚€ t [ Î´ ]

    sb-id : âˆ€ {Î“ A} (x : ğ”—ğ”ªâ‚€ Î“ A) â†’ x [ id {Î“} ] â†¦â‚€ x
    sb-app : âˆ€ {Î” Î“ A B} (Î³ : ğ”—ğ”ª Î” Î“) (f : ğ”—ğ”ªâ‚€ Î“ (A â‡’ B)) (x : ğ”—ğ”ªâ‚€ Î“ A)
           â†’ (f â¦… x â¦†) [ Î³ ] â†¦â‚€ (f [ Î³ ]) â¦… x [ Î³ ] â¦†
    sb-lam : âˆ€ {Î” Î“ A B} (Î³ : ğ”—ğ”ª Î” Î“) (f : ğ”—ğ”ªâ‚€ (Î“ Â· A) B)
           â†’ (Î› f) [ Î³ ] â†¦â‚€ Î› (f [ â†‘[ Î³ ] ])
    sb-assoc : âˆ€ {Î“ Î” Î A} (Î´ : ğ”—ğ”ª Î” Î“) (Î³ : ğ”—ğ”ª Î Î”) (t : ğ”—ğ”ªâ‚€ Î“ A)
           â†’ (t [ Î´ ]) [ Î³ ] â†¦â‚€ t [ Î´ âˆ˜ Î³ ]

  data _â†¦_ : âˆ€ {Î” Î“} â†’ ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ª Î” Î“ â†’ Set a where
    !    : âˆ€ {Î“} (Î³ : ğ”—ğ”ª Î“ ğŸ™) â†’ Î³ â†¦ !
    _âˆ·â‚—_ : âˆ€ {Î” Î“ A} {Î³ Î´ : ğ”—ğ”ª Î” Î“} â†’ Î³ â†¦ Î´ â†’ (a : ğ”—ğ”ªâ‚€ Î” A) â†’ (Î³ âˆ· a) â†¦ (Î´ âˆ· a)
    _âˆ·áµ£_ : âˆ€ {Î” Î“ A} â†’ (Î³ : ğ”—ğ”ª Î” Î“) â†’ {a b : ğ”—ğ”ªâ‚€ Î” A} â†’ a â†¦â‚€ b â†’ (Î³ âˆ· a) â†¦ (Î³ âˆ· b)

data _~_ : âˆ€ {Î” Î“} â†’ ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ª Î” Î“ â†’ Set a where
  fwd : âˆ€ {Î” Î“} {Î³ Î´ : ğ”—ğ”ª Î“ Î”} â†’ Î³ â†¦ Î´ â†’ Î³ ~ Î´
  bwd : âˆ€ {Î” Î“} {Î³ Î´ : ğ”—ğ”ª Î“ Î”} â†’ Î´ â†¦ Î³ â†’ Î³ ~ Î´

data _â‰ˆ_ :  âˆ€ {Î” Î“} â†’ ğ”—ğ”ª Î” Î“ â†’ ğ”—ğ”ª Î” Î“ â†’ Set a where
  refl   : âˆ€ {Î” Î“} {Î³ : ğ”—ğ”ª Î” Î“} â†’ Î³ â‰ˆ Î³
  transâ‚€ : âˆ€ {Î” Î“} {Î¶ Î´ Î³ : ğ”—ğ”ª Î” Î“} â†’ Î¶ â‰ˆ Î´ â†’ Î´ ~ Î³ â†’ Î¶ â‰ˆ Î³

unit : âˆ€ {Î” Î“} {Î´ Î³ : ğ”—ğ”ª Î” Î“} â†’ Î´ â†¦ Î³ â†’ Î´ â‰ˆ Î³
unit x = transâ‚€ refl (fwd x)

sym-unit : âˆ€ {Î” Î“} {Î´ Î³ : ğ”—ğ”ª Î” Î“} â†’ Î´ â†¦ Î³ â†’ Î³ â‰ˆ Î´
sym-unit x = transâ‚€ refl (bwd x)

trans : âˆ€ {Î” Î“} {Î¶ Î´ Î³ : ğ”—ğ”ª Î” Î“} â†’ Î¶ â‰ˆ Î´ â†’ Î´ â‰ˆ Î³ â†’ Î¶ â‰ˆ Î³
trans ys refl          = ys
trans ys (transâ‚€ xs x) = transâ‚€ (trans ys xs) x

flip : âˆ€ {Î” Î“} {Î³ Î´ : ğ”—ğ”ª Î” Î“} â†’ Î³ ~ Î´ â†’ Î´ ~ Î³
flip (fwd x) = bwd x
flip (bwd x) = fwd x

-- TODO(@doctorn) optimise this
sym : âˆ€ {Î” Î“} {Î³ Î´ : ğ”—ğ”ª Î” Î“} â†’ Î³ â‰ˆ Î´ â†’ Î´ â‰ˆ Î³
sym refl                = refl
sym (transâ‚€ xs (fwd x)) = trans (sym-unit x) (sym xs)
sym (transâ‚€ xs (bwd x)) = trans (unit x) (sym xs)

âˆ·-congáµ£ : âˆ€ {Î” Î“ A} {Î³ : ğ”—ğ”ª Î” Î“} {a b : ğ”—ğ”ªâ‚€ Î” A}
          â†’ a â†¦â‚€ b â†’ Î³ âˆ· a â‰ˆ Î³ âˆ· b
âˆ·-congáµ£ x = unit (_ âˆ·áµ£ x)

âˆ·-congâ‚— : âˆ€ {Î” Î“ A} {Î³ Î´ : ğ”—ğ”ª Î” Î“} {a : ğ”—ğ”ªâ‚€ Î” A}
          â†’ Î³ â‰ˆ Î´ â†’ Î³ âˆ· a â‰ˆ Î´ âˆ· a
âˆ·-congâ‚— refl = refl
âˆ·-congâ‚— (transâ‚€ xs (fwd x)) = transâ‚€ (âˆ·-congâ‚— xs) (fwd (x âˆ·â‚— _))
âˆ·-congâ‚— (transâ‚€ xs (bwd x)) = transâ‚€ (âˆ·-congâ‚— xs) (bwd (x âˆ·â‚— _))

âˆ·-congâ‚‚ : âˆ€ {Î” Î“ A} {Î³ Î´ : ğ”—ğ”ª Î” Î“} {a b : ğ”—ğ”ªâ‚€ Î” A}
          â†’ Î³ â‰ˆ Î´ â†’ a â†¦â‚€ b â†’ Î³ âˆ· a â‰ˆ Î´ âˆ· b
âˆ·-congâ‚‚ x y = trans (âˆ·-congâ‚— x) (âˆ·-congáµ£ y)

Ï€-ext : âˆ€ {Î Î” Î“ A} {Î´ : ğ”—ğ”ª Î Î”} {Î³ : ğ”—ğ”ª Î” Î“} {a : ğ”—ğ”ªâ‚€ Î A} â†’ Ï€ Î³ âˆ˜ (Î´ âˆ· a) â‰ˆ Î³ âˆ˜ Î´
Ï€-ext {Î“ = ğŸ™} {Î³ = !} = refl
Ï€-ext {Î“ = Î“ Â· B} {Î´ = Î´} {Î³ âˆ· b} {a} = âˆ·-congâ‚‚ Ï€-ext (p b Î´ a)

âˆ˜-identityË¡ : âˆ€ {Î” Î“} {Î³ : ğ”—ğ”ª Î” Î“} â†’ id âˆ˜ Î³ â‰ˆ Î³
âˆ˜-identityË¡ {Î“ = ğŸ™}     {Î³ = !} = refl
âˆ˜-identityË¡ {Î“ = Î“ Â· A} {Î³ âˆ· a} = âˆ·-congâ‚‚ (trans Ï€-ext âˆ˜-identityË¡) (ğ“ Î³ a)

âˆ˜-identityÊ³ : âˆ€ {Î” Î“} {Î³ : ğ”—ğ”ª Î” Î“} â†’ Î³ âˆ˜ id â‰ˆ Î³
âˆ˜-identityÊ³ {Î“ = ğŸ™}     {Î³ = !}     = refl
âˆ˜-identityÊ³ {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} = âˆ·-congâ‚‚ âˆ˜-identityÊ³ (sb-id a)

âˆ˜-identityÂ² : âˆ€ {Î“} â†’ id âˆ˜ id â‰ˆ id {Î“}
âˆ˜-identityÂ² {Î“ = ğŸ™}     = refl
âˆ˜-identityÂ² {Î“ = Î“ Â· A} = âˆ·-congâ‚‚ (trans Ï€-ext âˆ˜-identityË¡) (ğ“ (Ï€ id) ğ“)

âˆ˜-assoc : âˆ€ {Î© Î Î” Î“} {Î³ : ğ”—ğ”ª Î” Î“} {Î´ : ğ”—ğ”ª Î Î”} {Î¶ : ğ”—ğ”ª Î© Î}
          â†’ (Î³ âˆ˜ Î´) âˆ˜ Î¶ â‰ˆ Î³ âˆ˜ (Î´ âˆ˜ Î¶)
âˆ˜-assoc {Î³ = !}     {Î´} {Î¶} = refl
âˆ˜-assoc {Î³ = Î³ âˆ· x} {Î´} {Î¶} = âˆ·-congâ‚‚ âˆ˜-assoc (sb-assoc Î´ Î¶ x)

âˆ˜-sym-assoc : âˆ€ {Î© Î Î” Î“} {Î³ : ğ”—ğ”ª Î” Î“} {Î´ : ğ”—ğ”ª Î Î”} {Î¶ : ğ”—ğ”ª Î© Î}
              â†’ Î³ âˆ˜ (Î´ âˆ˜ Î¶) â‰ˆ (Î³ âˆ˜ Î´) âˆ˜ Î¶
âˆ˜-sym-assoc = sym âˆ˜-assoc

âˆ˜-stepâ‚— : âˆ€ {Î Î” Î“} {Î³ Î³' : ğ”—ğ”ª Î” Î“} {Î´ : ğ”—ğ”ª Î Î”}
         â†’ Î³ ~ Î³' â†’ Î³ âˆ˜ Î´ ~ Î³' âˆ˜ Î´
âˆ˜-stepâ‚— {Î“ = ğŸ™} {Î³ = !} x = bwd (! (_ âˆ˜ _))
âˆ˜-stepâ‚— {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} (fwd (x âˆ·â‚— a))
  with âˆ˜-stepâ‚— (fwd x)
... | fwd x' = fwd (x' âˆ·â‚— (a [ _ ]))
... | bwd x' = bwd (x' âˆ·â‚— (a [ _ ]))
âˆ˜-stepâ‚— {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} (bwd (x âˆ·â‚— a))
  with âˆ˜-stepâ‚— (bwd x)
... | fwd x' = fwd (x' âˆ·â‚— (a [ _ ]))
... | bwd x' = bwd (x' âˆ·â‚— (a [ _ ]))
âˆ˜-stepâ‚— {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} (fwd (Î³ âˆ·áµ£ x)) = fwd ((Î³ âˆ˜ _) âˆ·áµ£ (x [ _ ]â‚—))
âˆ˜-stepâ‚— {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} (bwd (Î³ âˆ·áµ£ x)) = bwd ((Î³ âˆ˜ _) âˆ·áµ£ (x [ _ ]â‚—))

âˆ˜-stepáµ£ : âˆ€ {Î Î” Î“} {Î³ : ğ”—ğ”ª Î” Î“} {Î´ Î´' : ğ”—ğ”ª Î Î”}
         â†’ Î´ ~ Î´' â†’ Î³ âˆ˜ Î´ â‰ˆ Î³ âˆ˜ Î´'
âˆ˜-stepáµ£ {Î“ = ğŸ™} {Î³ = !} x = refl
âˆ˜-stepáµ£ {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} (fwd (x âˆ·â‚— b)) = âˆ·-congâ‚‚ (âˆ˜-stepáµ£ (fwd (x âˆ·â‚— b))) (a [ x âˆ·â‚— b ]áµ£)
âˆ˜-stepáµ£ {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} (fwd (Î´ âˆ·áµ£ x)) = âˆ·-congâ‚‚ (âˆ˜-stepáµ£ (fwd (Î´ âˆ·áµ£ x))) (a [ Î´ âˆ·áµ£ x ]áµ£)
âˆ˜-stepáµ£ {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} (bwd (x âˆ·â‚— b)) = sym (âˆ·-congâ‚‚ (âˆ˜-stepáµ£ (fwd (x âˆ·â‚— b))) (a [ x âˆ·â‚— b ]áµ£))
âˆ˜-stepáµ£ {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} (bwd (Î´ âˆ·áµ£ x)) = sym (âˆ·-congâ‚‚ (âˆ˜-stepáµ£ (fwd (Î´ âˆ·áµ£ x))) (a [ Î´ âˆ·áµ£ x ]áµ£))
âˆ˜-stepáµ£ {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} (fwd (! Î´))    = âˆ·-congâ‚‚ (âˆ˜-stepáµ£ (fwd (! Î´))) (a [ ! Î´ ]áµ£)
âˆ˜-stepáµ£ {Î“ = Î“ Â· A} {Î³ = Î³ âˆ· a} (bwd (! Î´))    = sym (âˆ·-congâ‚‚ (âˆ˜-stepáµ£ (fwd (! Î´))) (a [ ! Î´ ]áµ£))

âˆ˜-congâ‚— : âˆ€ {Î Î” Î“} {Î³ Î³' : ğ”—ğ”ª Î” Î“} {Î´ : ğ”—ğ”ª Î Î”}
           â†’ Î³ â‰ˆ Î³' â†’ Î³ âˆ˜ Î´ â‰ˆ Î³' âˆ˜ Î´
âˆ˜-congâ‚— refl          = refl
âˆ˜-congâ‚— (transâ‚€ xs x) = transâ‚€ (âˆ˜-congâ‚— xs) (âˆ˜-stepâ‚— x)

âˆ˜-congáµ£ : âˆ€ {Î Î” Î“} {Î³ : ğ”—ğ”ª Î” Î“} {Î´ Î´' : ğ”—ğ”ª Î Î”}
           â†’ Î´ â‰ˆ Î´' â†’ Î³ âˆ˜ Î´ â‰ˆ Î³ âˆ˜ Î´'
âˆ˜-congáµ£ refl          = refl
âˆ˜-congáµ£ (transâ‚€ xs x) = trans (âˆ˜-congáµ£ xs) (âˆ˜-stepáµ£ x)

âˆ˜-resp-â‰ˆ : âˆ€ {Î Î” Î“} {Î³ Î³' : ğ”—ğ”ª Î” Î“} {Î´ Î´' : ğ”—ğ”ª Î Î”}
           â†’ Î³ â‰ˆ Î³' â†’ Î´ â‰ˆ Î´' â†’ Î³ âˆ˜ Î´ â‰ˆ Î³' âˆ˜ Î´'
âˆ˜-resp-â‰ˆ x y = trans (âˆ˜-congâ‚— x) (âˆ˜-congáµ£ y)

ğ•‹ğ• : Category a a a
ğ•‹ğ• = record
  { Obj = â„­
  ; _â‡’_ = ğ”—ğ”ª
  ; _â‰ˆ_ = _â‰ˆ_
  ; id = id
  ; _âˆ˜_ = _âˆ˜_
  ; assoc = âˆ˜-assoc
  ; sym-assoc = âˆ˜-sym-assoc
  ; identityË¡ = âˆ˜-identityË¡
  ; identityÊ³ = âˆ˜-identityÊ³
  ; identityÂ² = âˆ˜-identityÂ²
  ; equiv = record { refl = refl ; sym = sym ; trans = trans }
  ; âˆ˜-resp-â‰ˆ = âˆ˜-resp-â‰ˆ
  }
