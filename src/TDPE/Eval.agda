module TDPE.Eval where

open import TDPE.Base
open import Data.Product using (_Ã—_; projâ‚; projâ‚‚; _,_)
open import Function using () renaming (_âˆ˜_ to _$_)

-- closures
record ğ“› (Î“ : ğ’) (A : ğ’° áµ€) : Set where
  constructor L
  field
    {Î”} : ğ’
    f   : ğ“âŸ¦ Î” âŸ§ğ’ â†’ ğ“âŸ¦ A âŸ§áµ€
    w   : ğ’² Î“ Î”

  â†’ğ”—ğ”ª : ğ”—ğ”ª Î“ A
  â†’ğ”—ğ”ª = +ğ”—ğ”ª _ w (Î· Î” A f)
    where Î· : âˆ€ Î” A â†’ (ğ“âŸ¦ Î” âŸ§ğ’ â†’ ğ“âŸ¦ A âŸ§áµ€) â†’ ğ”—ğ”ª Î” A
          Î· ğŸ™       A f = ğ“ (f !)
          Î· (Î” Â· _) A f =
            +ğ”—ğ”ª _ (Ï‰â‚ Ïµ) (Î· _ _ Î» Î³ a â†’ f âŸ¨ Î³ âˆ· a âŸ©) â¦… ğ“ â¦†

data ğ• : ğ’ â†’ ğ’° áµ€ â†’ Set where
  ğ“ : âˆ€ {Î“ A} â†’ ğ• (Î“ Â· A) A
  Ï€ : âˆ€ {Î“ A B} â†’ ğ• Î“ A â†’ ğ• (Î“ Â· B) A

-- neutrals & normals
mutual
  data ğ”‘ğ”¢ : ğ’ â†’ ğ’° áµ€ â†’ Set where
    ğ“‹     : âˆ€ {Î“ A} â†’ ğ• Î“ A â†’ ğ”‘ğ”¢ Î“ A
    fst   : âˆ€ {Î“ A B} â†’ ğ”‘ğ”¢ Î“ (A âŠ— B) â†’ ğ”‘ğ”¢ Î“ A
    snd   : âˆ€ {Î“ A B} â†’ ğ”‘ğ”¢ Î“ (A âŠ— B) â†’ ğ”‘ğ”¢ Î“ B
    _â¦…_â¦†â‚ : âˆ€ {Î“ A B} â†’ ğ”‘ğ”¢ Î“ (A â‡’ B) â†’ ğ”‘ğ”£ Î“ A â†’ ğ”‘ğ”¢ Î“ B
    _â¦…_â¦†â‚‚ : âˆ€ {Î“ A B} â†’ ğ“› Î“ (A â‡’ B) â†’ ğ”‘ğ”¢ Î“ A â†’ ğ”‘ğ”¢ Î“ B

  data ğ”‘ğ”£ : ğ’ â†’ ğ’° áµ€ â†’ Set where
    Î¹ : âˆ€ {Î“ A} â†’ ğ”‘ğ”¢ Î“ ` A ` â†’ ğ”‘ğ”£ Î“ ` A `
    â¦…_,_â¦† : âˆ€ {Î“ A B} â†’ ğ”‘ğ”£ Î“ A â†’ ğ”‘ğ”£ Î“ B â†’ ğ”‘ğ”£ Î“ (A âŠ— B)
    Î› : âˆ€ {Î“ A B} â†’ ğ”‘ğ”£ (Î“ Â· A) B â†’ ğ”‘ğ”£ Î“ (A â‡’ B)
    ğ“ : âˆ€ {Î“ A} â†’ ğ“› Î“ A â†’ ğ”‘ğ”£ Î“ A

-- weakenings
+' : âˆ€ A â†’ ğ’²+ (Î» Î“ â†’ ğ”‘ğ”¢ Î“ A)
+ : âˆ€ A â†’ ğ’²+ (Î» Î“ â†’ ğ”‘ğ”£ Î“ A)

+' _ Ïµâ‚€ t          = t
+' _ w  (ğ“‹ x)      = ğ“‹ (+ğ• w x)
  where +ğ• : âˆ€ {A} â†’ ğ’²+ (Î» Î“ â†’ ğ• Î“ A)
        +ğ• Ïµâ‚€     x     = x
        +ğ• (Ï‰â‚ w) x     = Ï€ (+ğ• w x)
        +ğ• (Ï‰â‚‚ w) ğ“     = ğ“
        +ğ• (Ï‰â‚‚ w) (Ï€ x) = Ï€ (+ğ• w x)
+' _ w  (fst x)    = fst (+' _ w x)
+' _ w  (snd x)    = snd (+' _ w x)
+' _ w  (f â¦… x â¦†â‚) = +' _ w f â¦… + _ w x â¦†â‚
+' _ w  (L f w' â¦… x â¦†â‚‚) = L f (w âˆ˜ w') â¦… +' _ w x â¦†â‚‚

+ _ Ïµâ‚€ t            = t
+ _ w  (Î¹ x)        = Î¹ (+' _ w x)
+ _ w  â¦… tâ‚ , tâ‚‚ â¦†  = â¦… + _ w tâ‚ , + _ w tâ‚‚ â¦†
+ _ w  (Î› t)        = Î› (+ _ (Ï‰â‚‚ w) t)
+ _ w  (ğ“ (L f w')) = ğ“ (L f (w âˆ˜ w'))

-- embeddings
ğ’¾ : âˆ€ {Î“ A} â†’ ğ”‘ğ”£ Î“ A â†’ ğ”—ğ”ª Î“ A
ğ’¾' : âˆ€ {Î“ A} â†’ ğ”‘ğ”¢ Î“ A â†’ ğ”—ğ”ª Î“ A

ğ’¾ (Î¹ x)        = ğ’¾' x
ğ’¾ â¦… tâ‚ , tâ‚‚ â¦†  = â¦… ğ’¾ tâ‚ , ğ’¾ tâ‚‚ â¦†
ğ’¾ (Î› t)        = Î› (ğ’¾ t)
ğ’¾ (ğ“ l)        = ğ“›.â†’ğ”—ğ”ª l
ğ’¾' (ğ“‹ x)       = ğ’¾ğ“‹ x
  where ğ’¾ğ“‹ : âˆ€ {Î“ A} â†’ ğ• Î“ A â†’ ğ”—ğ”ª Î“ A
        ğ’¾ğ“‹ ğ“     = ğ“
        ğ’¾ğ“‹ (Ï€ x) = Ï€ (ğ’¾ğ“‹ x)
ğ’¾' (fst t)    = fst (ğ’¾' t)
ğ’¾' (snd t)    = snd (ğ’¾' t)
ğ’¾' (f â¦… x â¦†â‚) = ğ’¾' f â¦… ğ’¾ x â¦†
ğ’¾' (f â¦… x â¦†â‚‚) = ğ“›.â†’ğ”—ğ”ª f â¦… ğ’¾' x â¦†

-- relation
ğ“¡âŸ¦_âŸ§áµ€ : ğ’° áµ€ â†’ ğ’ â†’ Set
ğ“¡âŸ¦ Ï„ âŸ§áµ€ = âŸ¦ Ï„ âŸ§áµ€ (Î» A Î” â†’ ğ”‘ğ”£ Î” ` A `)
                 (Î» P Q Î” â†’ P Î” Ã— Q Î”)
                 (Î» P Q Î” â†’ âˆ€ Î“ â†’ ğ’² Î“ Î” â†’ P Î“ â†’ Q Î“)
ğ“¡âŸ¦_âŸ§ğ’ : ğ’ â†’ ğ’ â†’ Set
ğ“¡âŸ¦_âŸ§ğ’ Î” Î“ = âŸ¨ (Î» A â†’ ğ“¡âŸ¦ A âŸ§áµ€ Î“) âŸ© Î”

+ğ“¡ : âˆ€ A â†’ ğ’²+ ğ“¡âŸ¦ A âŸ§áµ€
+ğ“¡ ` A `               = + ` A `
+ğ“¡ (A âŠ— B) w (Î·â‚ , Î·â‚‚) = +ğ“¡ A w Î·â‚ , +ğ“¡ B w Î·â‚‚
+ğ“¡ (A â‡’ B) w Î· Î“ w'    = Î· Î“ (w' âˆ˜ w)

ğ”® : âˆ€ A Î“ â†’ ğ“¡âŸ¦ A âŸ§áµ€ Î“ â†’ ğ”‘ğ”£ Î“ A
ğ”² : âˆ€ A Î“ â†’ ğ”‘ğ”¢ Î“ A â†’ ğ“¡âŸ¦ A âŸ§áµ€ Î“

ğ”® ` A `   Î” x         = x
ğ”® (A âŠ— B) Î” (xâ‚ , xâ‚‚) = â¦… ğ”® A Î” xâ‚ , ğ”® B Î” xâ‚‚ â¦†
ğ”® (A â‡’ B) Î” x         = Î› (ğ”® B (Î” Â· A) (x (Î” Â· A) (Ï‰â‚ Ïµ) (ğ”² A (Î” Â· A) (ğ“‹ ğ“))))

ğ”² ` A `   Î” x       = Î¹ x
ğ”² (A âŠ— B) Î” x       = ğ”² A Î” (fst x) , ğ”² B Î” (snd x)
ğ”² (A â‡’ B) Î” x Î“ w y = ğ”² B Î“ (+' (A â‡’ B) w x â¦… ğ”® A Î“ y â¦†â‚)

â†‘ : âˆ€ A Î“ â†’ ğ“¡âŸ¦ A âŸ§áµ€ Î“ â†’ ğ“âŸ¦ Î“ âŸ§ğ’ â†’ ğ“âŸ¦ A âŸ§áµ€
â†“ : âˆ€ A Î“ â†’ (ğ“âŸ¦ Î“ âŸ§ğ’ â†’ ğ“âŸ¦ A âŸ§áµ€) â†’ âˆ€ Î” â†’ ğ’² Î” Î“ â†’ ğ“¡âŸ¦ A âŸ§áµ€ Î”

â†‘ ` A ` Î“ (Î¹ x)       Î´ = ğ“âŸ¦ ğ’¾' x âŸ§ Î´
â†‘ ` A ` Î“ (ğ“ (L f w)) Î´ = f (+ğ“ w Î´)
â†‘ (A âŠ— B) Î“ (xâ‚ , xâ‚‚) Î´ = â†‘ A Î“ xâ‚ Î´ , â†‘ B Î“ xâ‚‚ Î´
â†‘ (A â‡’ B) Î“ f         Î´ = Î» x â†’ â†‘ B (Î“ Â· A) (f (Î“ Â· A) (Ï‰â‚ Ïµ) (â†“ A (Î“ Â· A) ğ“© (Î“ Â· A) Ïµ)) âŸ¨ Î´ âˆ· x âŸ©

â†“ ` A `   Î“ x Î” w        = ğ“ (L x w)
â†“ (A âŠ— B) Î“ x Î” w        = â†“ A Î“ (projâ‚ $ x) Î” w , â†“ B Î“ (projâ‚‚ $ x) Î” w
â†“ (A â‡’ B) Î“ f Î” w Î w' y = â†“ B Î (Î» Î´ â†’ f (+ğ“ (w' âˆ˜ w) Î´) (â†‘ A Î y Î´)) Î Ïµ

id : âˆ€ Î“ â†’ ğ“¡âŸ¦ Î“ âŸ§ğ’ Î“
id ğŸ™       = !
id (Î“ Â· A) = âŸ¨ âŸ¨+âŸ© +ğ“¡ Î“ (Ï‰â‚ Ïµ) (id Î“) âˆ· ğ”² A (Î“ Â· A) (ğ“‹ ğ“) âŸ©

âŸ¦_âŸ§ : âˆ€ {Î“ A} â†’ ğ”—ğ”ª Î“ A
     â†’ âˆ€ Î” â†’ ğ“¡âŸ¦ Î“ âŸ§ğ’ Î” â†’ ğ“¡âŸ¦ A âŸ§áµ€ Î”
âŸ¦ ğ“           âŸ§ Î” âŸ¨ _ âˆ· a âŸ© = a
âŸ¦ Ï€ t         âŸ§ Î” âŸ¨ Î³ âˆ· _ âŸ© = âŸ¦ t âŸ§ Î” Î³
âŸ¦ fst t       âŸ§ Î” Î³ = projâ‚ (âŸ¦ t âŸ§ Î” Î³)
âŸ¦ snd t       âŸ§ Î” Î³ = projâ‚‚ (âŸ¦ t âŸ§ Î” Î³)
âŸ¦ â¦… tâ‚ , tâ‚‚ â¦† âŸ§ Î” Î³ = âŸ¦ tâ‚ âŸ§ Î” Î³ , âŸ¦ tâ‚‚ âŸ§ Î” Î³
âŸ¦ f â¦… x â¦†     âŸ§ Î” Î³ = âŸ¦ f âŸ§ Î” Î³ Î” Ïµ (âŸ¦ x âŸ§ Î” Î³)
âŸ¦ Î› t         âŸ§ Î” Î³ Î“ w x = âŸ¦ t âŸ§ Î“ âŸ¨ âŸ¨+âŸ© +ğ“¡ _ w Î³ âˆ· x âŸ©
âŸ¦_âŸ§ {A = A} (ğ“ l) Î” Î³ = â†“ A Î” (Î» _ â†’ l) Î” Ïµ

nf : âˆ€ {Î“ A} â†’ ğ”—ğ”ª Î“ A â†’ ğ”‘ğ”£ Î“ A
nf {Î“} {A} t = ğ”® A Î“ (âŸ¦ t âŸ§ Î“ (id Î“))

normalise : âˆ€ {Î“ A} â†’ ğ”—ğ”ª Î“ A â†’ ğ”—ğ”ª Î“ A
normalise t = ğ’¾ (nf t)
